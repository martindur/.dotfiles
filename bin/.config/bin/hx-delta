#!/bin/bash
# View git diff for a file using delta in a new wezterm tab
# Usage: hx-delta <filepath>

FILE="${1:-.}"

# Get the git root and make the file path relative to it
GIT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)

# Convert absolute path to relative path from git root
if [[ "$FILE" = /* ]]; then
  REL_FILE="${FILE#$GIT_ROOT/}"
else
  REL_FILE="$FILE"
fi

# Capture current pane and tab info
ORIGINAL_TAB=$(wezterm cli list --format json | jq -r ".[] | select(.pane_id == $WEZTERM_PANE) | .tab_id")

# Spawn delta in a new tab
wezterm cli spawn --cwd "$GIT_ROOT" -- bash -c "git diff -- \"$REL_FILE\" | delta --paging=always; wezterm cli activate-tab --tab-id $ORIGINAL_TAB" > /dev/null
